generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  affiliate
  admin
}

enum UserStatus {
  active
  suspended
  disabled
}

enum KycStatus {
  pending
  verified
  rejected
}

enum PaymentStatus {
  pending
  paid
  refunded
  canceled
}

enum CommissionStatus {
  pending
  approved
  rejected
  reversed
}

enum PayoutBatchStatus {
  open
  processing
  paid
  failed
}

enum PayoutLineStatus {
  pending
  queued
  processing
  paid
  failed
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String
  role           UserRole  @default(affiliate)
  status         UserStatus @default(active)
  emailVerifiedAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?
  tokenVersion   Int       @default(0)
  affiliate      AffiliateProfile?
  adminProfile   AdminProfile?
  auditLogs      AuditLog[]
  payoutBatches  PayoutBatch[] @relation("PayoutBatchInitiator")
  refreshTokens  RefreshToken[]
  verificationCodes VerificationCode[]
  resolvedFraudAlerts FraudAlert[] @relation("FraudAlertResolver")
}

model AdminProfile {
  id           String   @id @default(cuid())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String   @unique
  displayName  String?
  permissions  Json?
  timezone     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model AffiliateProfile {
  id                    String    @id @default(cuid())
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String    @unique
  displayName           String?
  defaultReferralCode   String    @unique
  phone                 String?   @unique
  phoneEnc              String?   @db.Text
  phoneHash             String?   @unique
  phoneVerifiedAt       DateTime?
  socialLinks           Json?
  panNumber             String
  panEnc                String?   @db.Text
  panHash               String?   @unique
  aadhaarNumber         String
  aadhaarEnc            String?   @db.Text
  aadhaarHash           String?   @unique
  panImageUrl          String?
  aadhaarFrontUrl      String?
  aadhaarBackUrl       String?
  kycStatus             KycStatus @default(pending)
  payoutMethod          String?
  payoutDetails         Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  deletedAt             DateTime?
  links                 AffiliateLink[]
  coupons               Coupon[]
  attributions          Attribution[]
  commissionLedger      CommissionLedger[]
  payoutLines           PayoutLine[]
  commissionScopes      CommissionRuleScope[]
  fraudAlerts           FraudAlert[]
}

model Category {
  id          String    @id @default(cuid())
  name        String
  description String?
  products    Product[]
  commissionScopes CommissionRuleScope[]
}

model Product {
  id                 String          @id @default(cuid())
  externalProductId  String?
  name               String
  sku                String?
  description        String?
  price              Decimal         @db.Decimal(12, 2)
  currency           String          @default("INR")
  imageUrl           String?
  landingUrl         String?
  isActive           Boolean         @default(true)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  deletedAt          DateTime?
  category           Category?       @relation(fields: [categoryId], references: [id])
  categoryId         String?
  links              AffiliateLink[]
  orderItems         OrderItem[]
  commissionScopes   CommissionRuleScope[]
}

model AffiliateLink {
  id            String    @id @default(cuid())
  affiliate     AffiliateProfile @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  affiliateId   String
  product       Product?  @relation(fields: [productId], references: [id])
  productId     String?
  code          String    @unique
  landingUrl    String
  utmDefaults   Json?
  expiresAt     DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  deletedAt     DateTime?
  clicks        Click[]

  @@index([affiliateId, isActive])
  @@index([affiliateId, createdAt])
}

model Coupon {
  id            String    @id @default(cuid())
  code          String    @unique
  affiliate     AffiliateProfile @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  affiliateId   String
  discountValue Decimal   @db.Decimal(12, 2)
  discountType  String
  startsAt      DateTime?
  endsAt        DateTime?
  isActive      Boolean   @default(true)
  deletedAt     DateTime?
  attributions  Attribution[]

  @@index([affiliateId, isActive])
}

model Click {
  id               String      @id @default(cuid())
  affiliateLink    AffiliateLink @relation(fields: [affiliateLinkId], references: [id], onDelete: Cascade)
  affiliateLinkId  String
  sessionId        String?
  cookieId         String?
  userAgent        String?
  ipHash           String?
  referrer         String?
  utm              Json?
  clickedAt        DateTime    @default(now())
  isBot            Boolean     @default(false)
  consentGiven     Boolean     @default(false)
  botFlags         Int         @default(0)
  riskScore        Decimal?    @db.Decimal(6, 2)
  attributions     Attribution[]
  fraudAlerts      FraudAlert[]

  @@index([affiliateLinkId, clickedAt])
  @@index([cookieId, clickedAt])
}

model Order {
  id               String      @id @default(cuid())
  externalOrderId  String      @unique
  placedAt         DateTime
  totalGross       Decimal?    @db.Decimal(12, 2)
  totalNet         Decimal?    @db.Decimal(12, 2)
  currency         String      @default("USD")
  paymentStatus    PaymentStatus @default(paid)
  customerHash     String?
  storeId          String?
  couponCode       String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  items            OrderItem[]
  attributions     Attribution[]
  commissionLedger CommissionLedger[]
  refunds          RefundEvent[]
  fraudAlerts      FraudAlert[]

  @@index([storeId, placedAt])
  @@index([paymentStatus, placedAt])
  @@index([customerHash, placedAt])
}

model OrderItem {
  id             String    @id @default(cuid())
  order          Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId        String
  product        Product?  @relation(fields: [productId], references: [id])
  productId      String?
  externalLineItemId String? @unique
  quantity       Int
  unitPriceNet   Decimal   @db.Decimal(12, 2)
  discountAmount Decimal?  @db.Decimal(12, 2)
  lineTotalNet   Decimal   @db.Decimal(12, 2)
  commissionLedger CommissionLedger[]
  refundEvents   RefundEvent[]

  @@index([orderId])
}

model Attribution {
  id                  String           @id @default(cuid())
  order               Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId             String
  affiliate           AffiliateProfile @relation(fields: [affiliateId], references: [id])
  affiliateId         String
  click               Click?           @relation(fields: [clickId], references: [id])
  clickId             String?
  coupon              Coupon?          @relation(fields: [couponId], references: [id])
  couponId            String?
  model               String
  weight              Decimal?         @db.Decimal(5, 4)
  revenueAttributed   Decimal?         @db.Decimal(12, 2)
  decidedAt           DateTime         @default(now())

  @@index([affiliateId, decidedAt])
}

model CommissionRule {
  id                   String                 @id @default(cuid())
  name                 String
  type                 String
  rate                 Decimal                @db.Decimal(7, 4)
  excludeTaxShipping   Boolean                @default(true)
  startsAt             DateTime?
  endsAt               DateTime?
  conditions           Json?
  isActive             Boolean                @default(true)
  scopes               CommissionRuleScope[]
  ledgerEntries        CommissionLedger[]
}

model CommissionRuleScope {
  id               String          @id @default(cuid())
  commissionRule   CommissionRule  @relation(fields: [commissionRuleId], references: [id], onDelete: Cascade)
  commissionRuleId String
  product          Product?        @relation(fields: [productId], references: [id])
  productId        String?
  category         Category?       @relation(fields: [categoryId], references: [id])
  categoryId       String?
  affiliate        AffiliateProfile? @relation(fields: [affiliateId], references: [id])
  affiliateId      String?
  country          String?

  @@unique([commissionRuleId, productId, categoryId, affiliateId, country])
}

model CommissionLedger {
  id             String            @id @default(cuid())
  affiliate      AffiliateProfile  @relation(fields: [affiliateId], references: [id])
  affiliateId    String
  order          Order              @relation(fields: [orderId], references: [id])
  orderId        String
  orderItem      OrderItem?         @relation(fields: [orderItemId], references: [id])
  orderItemId    String?
  rule           CommissionRule?    @relation(fields: [ruleId], references: [id])
  ruleId         String?
  amount         Decimal            @db.Decimal(12, 2)
  currency       String             @default("USD")
  status         CommissionStatus   @default(pending)
  effectiveRate  Decimal?           @db.Decimal(7, 4)
  reason         String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  lockedAt       DateTime?
  graceUntil     DateTime?
  payoutLine     PayoutLine?        @relation(fields: [payoutLineId], references: [id])
  payoutLineId   String?

  @@index([affiliateId, status, createdAt])
  @@index([orderId])
}

model PayoutBatch {
  id           String       @id @default(cuid())
  periodStart  DateTime
  periodEnd    DateTime
  method       String?
  provider     String?
  providerBatchId String?
  receiptUrl   String?
  reconciledAt DateTime?
  status       PayoutBatchStatus @default(open)
  totalAmount  Decimal?      @db.Decimal(12, 2)
  currency     String       @default("USD")
  initiatedBy  User?        @relation("PayoutBatchInitiator", fields: [initiatedById], references: [id])
  initiatedById String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  lines        PayoutLine[]
}

model PayoutLine {
  id                String            @id @default(cuid())
  batch             PayoutBatch       @relation(fields: [batchId], references: [id])
  batchId           String
  affiliate         AffiliateProfile  @relation(fields: [affiliateId], references: [id])
  affiliateId       String
  amount            Decimal           @db.Decimal(12, 2)
  currency          String            @default("USD")
  externalPayoutId  String?
  status            PayoutLineStatus  @default(pending)
  note              String?
  createdAt         DateTime          @default(now())
  commissionLedger  CommissionLedger[]

  @@index([affiliateId, createdAt])
  @@index([batchId])
}

model RefundEvent {
  id            String      @id @default(cuid())
  order         Order       @relation(fields: [orderId], references: [id])
  orderId       String
  orderItem     OrderItem   @relation(fields: [orderItemId], references: [id])
  orderItemId   String
  amount        Decimal     @db.Decimal(12, 2)
  reason        String?
  refundAt      DateTime    @default(now())

  @@index([orderId])
}

model AuditLog {
  id          String   @id @default(cuid())
  user        User?    @relation(fields: [userId], references: [id])
  userId      String?
  action      String
  entityType  String
  entityId    String?
  meta        Json?
  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
}

model FraudAlert {
  id           String    @id @default(cuid())
  affiliate    AffiliateProfile @relation(fields: [affiliateId], references: [id])
  affiliateId  String
  order        Order?    @relation(fields: [orderId], references: [id])
  orderId      String?
  click        Click?    @relation(fields: [clickId], references: [id])
  clickId      String?
  riskScore    Decimal   @db.Decimal(5, 2)
  type         String
  details      Json?
  status       String    @default("open")
  notes        String?
  resolvedAt   DateTime?
  resolvedBy   User?     @relation("FraudAlertResolver", fields: [resolvedById], references: [id])
  resolvedById String?
  createdAt    DateTime  @default(now())

  @@index([affiliateId, status, createdAt])
  @@index([orderId])
  @@index([clickId])
}

model RefreshToken {
  id              String   @id @default(cuid())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String
  tokenHash       String   @unique
  createdAt       DateTime @default(now())
  expiresAt       DateTime
  revokedAt       DateTime?
  replacedByToken String?
  createdByIp     String?
  lastUsedAt      DateTime?

  @@index([userId, expiresAt])
}

enum VerificationTarget {
  email
  phone
}

model VerificationCode {
  id           String             @id @default(cuid())
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  targetType   VerificationTarget
  targetValue  String
  codeHash     String
  expiresAt    DateTime
  consumedAt   DateTime?
  createdAt    DateTime          @default(now())
  attempts     Int               @default(0)
  channel      String?

  @@index([userId, targetType])
  @@index([targetType, targetValue])
}
