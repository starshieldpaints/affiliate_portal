generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  affiliate
  admin
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String
  role           UserRole  @default(affiliate)
  twofaEnabled   Boolean   @default(false)
  status         String    @default("active")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  affiliate      AffiliateProfile?
  auditLogs      AuditLog[]
  payoutBatches  PayoutBatch[] @relation("PayoutBatchInitiator")
}

model AffiliateProfile {
  id                    String    @id @default(cuid())
  user                  User      @relation(fields: [userId], references: [id])
  userId                String    @unique
  displayName           String?
  defaultReferralCode   String    @unique
  phone                 String?
  socialLinks           Json?
  taxId                 String?
  kycStatus             String    @default("pending")
  payoutMethod          String?
  payoutDetails         Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  links                 AffiliateLink[]
  coupons               Coupon[]
  attributions          Attribution[]
  commissionLedger      CommissionLedger[]
  payoutLines           PayoutLine[]
}

model Category {
  id          String    @id @default(cuid())
  name        String
  description String?
  products    Product[]
}

model Product {
  id                 String          @id @default(cuid())
  externalProductId  String?
  name               String
  sku                String?
  description        String?
  price              Decimal         @db.Numeric(12, 2)
  currency           String          @default("USD")
  imageUrl           String?
  landingUrl         String?
  isActive           Boolean         @default(true)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  category           Category?       @relation(fields: [categoryId], references: [id])
  categoryId         String?
  links              AffiliateLink[]
  orderItems         OrderItem[]
  commissionScopes   CommissionRuleScope[]
}

model AffiliateLink {
  id            String    @id @default(cuid())
  affiliate     AffiliateProfile @relation(fields: [affiliateId], references: [id])
  affiliateId   String
  product       Product?  @relation(fields: [productId], references: [id])
  productId     String?
  code          String
  landingUrl    String
  utmDefaults   Json?
  expiresAt     DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  clicks        Click[]
}

model Coupon {
  id            String    @id @default(cuid())
  code          String    @unique
  affiliate     AffiliateProfile @relation(fields: [affiliateId], references: [id])
  affiliateId   String
  discountValue Decimal   @db.Numeric(12, 2)
  discountType  String
  startsAt      DateTime?
  endsAt        DateTime?
  isActive      Boolean   @default(true)
  attributions  Attribution[]
}

model Click {
  id               String      @id @default(cuid())
  affiliateLink    AffiliateLink @relation(fields: [affiliateLinkId], references: [id])
  affiliateLinkId  String
  sessionId        String?
  cookieId         String?
  userAgent        String?
  ipHash           String?
  referrer         String?
  utm              Json?
  clickedAt        DateTime    @default(now())
  isBot            Boolean     @default(false)
  attributions     Attribution[]
}

model Order {
  id               String      @id @default(cuid())
  externalOrderId  String      @unique
  placedAt         DateTime
  totalGross       Decimal?    @db.Numeric(12, 2)
  totalNet         Decimal?    @db.Numeric(12, 2)
  currency         String      @default("USD")
  paymentStatus    String      @default("paid")
  customerHash     String?
  storeId          String?
  couponCode       String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  items            OrderItem[]
  attributions     Attribution[]
  commissionLedger CommissionLedger[]
  refunds          RefundEvent[]
}

model OrderItem {
  id             String    @id @default(cuid())
  order          Order     @relation(fields: [orderId], references: [id])
  orderId        String
  product        Product?  @relation(fields: [productId], references: [id])
  productId      String?
  quantity       Int
  unitPriceNet   Decimal   @db.Numeric(12, 2)
  discountAmount Decimal   @db.Numeric(12, 2)?
  lineTotalNet   Decimal   @db.Numeric(12, 2)
  commissionLedger CommissionLedger[]
  refundEvents   RefundEvent[]
}

model Attribution {
  id                  String           @id @default(cuid())
  order               Order            @relation(fields: [orderId], references: [id])
  orderId             String
  affiliate           AffiliateProfile @relation(fields: [affiliateId], references: [id])
  affiliateId         String
  click               Click?           @relation(fields: [clickId], references: [id])
  clickId             String?
  coupon              Coupon?          @relation(fields: [couponId], references: [id])
  couponId            String?
  model               String
  weight              Decimal?         @db.Numeric(5, 4)
  revenueAttributed   Decimal?         @db.Numeric(12, 2)
  decidedAt           DateTime         @default(now())
}

model CommissionRule {
  id                   String                 @id @default(cuid())
  name                 String
  type                 String
  rate                 Decimal                @db.Numeric(7, 4)
  excludeTaxShipping   Boolean                @default(true)
  startsAt             DateTime?
  endsAt               DateTime?
  conditions           Json?
  isActive             Boolean                @default(true)
  scopes               CommissionRuleScope[]
  ledgerEntries        CommissionLedger[]
}

model CommissionRuleScope {
  id               String          @id @default(cuid())
  commissionRule   CommissionRule  @relation(fields: [commissionRuleId], references: [id])
  commissionRuleId String
  product          Product?        @relation(fields: [productId], references: [id])
  productId        String?
  category         Category?       @relation(fields: [categoryId], references: [id])
  categoryId       String?
  affiliate        AffiliateProfile? @relation(fields: [affiliateId], references: [id])
  affiliateId      String?
  country          String?
}

model CommissionLedger {
  id             String            @id @default(cuid())
  affiliate      AffiliateProfile  @relation(fields: [affiliateId], references: [id])
  affiliateId   String
  order         Order              @relation(fields: [orderId], references: [id])
  orderId       String
  orderItem     OrderItem?         @relation(fields: [orderItemId], references: [id])
  orderItemId   String?
  rule          CommissionRule?    @relation(fields: [ruleId], references: [id])
  ruleId        String?
  amount        Decimal            @db.Numeric(12, 2)
  currency      String             @default("USD")
  status        String             @default("pending")
  effectiveRate Decimal?           @db.Numeric(7, 4)
  reason        String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  lockedAt      DateTime?
  payoutLine    PayoutLine?        @relation(fields: [payoutLineId], references: [id])
  payoutLineId  String?
}

model PayoutBatch {
  id           String       @id @default(cuid())
  periodStart  DateTime
  periodEnd    DateTime
  method       String?
  status       String       @default("open")
  totalAmount  Decimal      @db.Numeric(12, 2)?
  currency     String       @default("USD")
  initiatedBy  User?        @relation("PayoutBatchInitiator", fields: [initiatedById], references: [id])
  initiatedById String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  lines        PayoutLine[]
}

model PayoutLine {
  id                String            @id @default(cuid())
  batch             PayoutBatch       @relation(fields: [batchId], references: [id])
  batchId           String
  affiliate         AffiliateProfile  @relation(fields: [affiliateId], references: [id])
  affiliateId       String
  amount            Decimal           @db.Numeric(12, 2)
  currency          String            @default("USD")
  externalPayoutId  String?
  status            String            @default("pending")
  note              String?
  createdAt         DateTime          @default(now())
}

model RefundEvent {
  id            String      @id @default(cuid())
  orderItem     OrderItem   @relation(fields: [orderItemId], references: [id])
  orderItemId   String
  amount        Decimal     @db.Numeric(12, 2)
  reason        String?
  refundAt      DateTime    @default(now())
}

model AuditLog {
  id          String   @id @default(cuid())
  user        User?    @relation(fields: [userId], references: [id])
  userId      String?
  action      String
  entityType  String
  entityId    String?
  meta        Json?
  createdAt   DateTime @default(now())
}
